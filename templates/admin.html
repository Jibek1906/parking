<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка парковки</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: radial-gradient(circle at top, #0f172a, #020617);
            min-height: 100vh;
            color: #000000;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(90deg, #4facfe 0%, #53a9ee 100%);
            color: #fff !important;
            border: none;
        }
        .nav-tabs .nav-link {
            color: #0984e3;
            font-weight: 600;
        }
        .tab-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            padding: 32px 24px;
            margin-top: 16px;
        }
        .table thead th {
            background: #f8f9fa;
        }
        .modal-header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: #fff;
        }
        .btn-gradient {
            background: linear-gradient(90deg, #226fb0 0%, #1b476d 100%);
            color: #fff;
            border: none;
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #0984e3 0%, #51abf8 100%);
        }
        .flatpickr-calendar {
            z-index: 9999 !important;
        }
        .badge-completed {
            background: #27ae60;
        }
        .badge-timeout {
            background: #e67e22;
        }
        .badge-manual {
            background: #e74c3c;
        }
        .badge-active {
            background: #3498db;
        }
        .plate-simple {
            display: inline-flex;
            align-items: center;
            font-family: 'Arial Black', Arial, sans-serif;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #222;
            background: #fff;
            border: 1.5px solid #222;
            border-radius: 3px;
            padding: 1px 8px 1px 8px;
            margin: 0;
            min-width: 60px;
            height: 22px;
            line-height: 1;
        }
        .plate-region {
            font-size: 10px;
            font-weight: bold;
            color: #222;
            margin-right: 4px;
            vertical-align: middle;
        }
        .plate-sep {
            display: inline-block;
            width: 1.5px;
            height: 15px;
            background: #222;
            margin: 0 5px 0 0;
            border-radius: 1px;
        }
        .plate-main {
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #222;
        }
        .filter-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .filter-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <!-- Новый header в стиле idle.html, адаптированный под светлый фон -->
    <div class="d-flex align-items-center justify-content-between mb-4 px-2 py-3 rounded-3">
      <div class="d-flex align-items-center gap-3">
        <div style="width:56px;height:56px;border-radius:16px;background:#fff;display:flex;align-items:center;justify-content:center;">
          <img src="/static/1.jpg" alt="Логотип" style="width:44px;height:44px;object-fit:contain;">
        </div>
        <div>
          <div style="font-size:2rem;font-weight:600;color:#fff;letter-spacing:-1px;">Smart Parking</div>
          <div style="color:#cbd5e1;font-size:1rem;margin-top:2px;">Cистема умной парковки</div>
        </div>
      </div>
      <div class="text-end">
        <div id="adminHeaderTime" style="font-size:2.2rem;font-weight:400;color:#fff;letter-spacing:1px;"></div>
        <div style="color:#64748b;font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;">Текущее время</div>
      </div>
    </div>
    <script>
      function updateAdminHeaderTime() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        const el = document.getElementById('adminHeaderTime');
        if (el) el.textContent = `${h}:${m}:${s}`;
      }
      updateAdminHeaderTime();
      setInterval(updateAdminHeaderTime, 1000);
    </script>
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="mode-tab" data-bs-toggle="tab" data-bs-target="#modeTab" type="button" role="tab">Режим</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="barrier-tab" data-bs-toggle="tab" data-bs-target="#barrierTab" type="button" role="tab">Шлагбаум</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cameras-tab" data-bs-toggle="tab" data-bs-target="#camerasTab" type="button" role="tab">Камеры</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tariffs-tab" data-bs-toggle="tab" data-bs-target="#tariffsTab" type="button" role="tab">Тарифы</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="whitelist-tab" data-bs-toggle="tab" data-bs-target="#whitelistTab" type="button" role="tab">Белый список</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#activeTab" type="button" role="tab">Активные</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="visits-tab" data-bs-toggle="tab" data-bs-target="#visitsTab" type="button" role="tab">Визиты</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#paymentsTab" type="button" role="tab">Платежи</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button" role="tab">Аналитика</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errorsTab" type="button" role="tab">Ошибки сервера</button>
        </li>
    </ul>
    <div class="tab-content" id="adminTabsContent">
        <div class="tab-pane fade show active" id="modeTab" role="tabpanel">
            <form id="modeForm" class="mb-4">
                <label class="form-label fw-semibold">Режим работы парковки:</label>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="modeSwitch">
                    <label class="form-check-label" for="modeSwitch" id="modeSwitchLabel">С оплатой</label>
                </div>
                <button type="submit" class="btn btn-gradient">Сохранить режим</button>
            </form>
            <div>
                <span class="fw-semibold">Текущий режим:</span>
                <span id="currentMode" class="badge bg-info text-dark">Загрузка...</span>
            </div>
        </div>
<div class="tab-pane fade" id="barrierTab" role="tabpanel">
            <h5 class="fw-bold mb-4">Управление шлагбаумом</h5>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="text-center mb-4">
                        <div class="d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px; border-radius: 50%; background: #f8f9fa; border: 2px solid #dee2e6;">
                            <span style="font-size: 2.5rem;">&#128682;</span>
                        </div>
                        <p class="text-muted mb-4">Нажмите кнопку для открытия шлагбаума</p>
                    </div>
                    <form id="barrierForm">
                        <button type="submit" class="btn btn-gradient w-100 py-3 mb-3" style="font-size: 1.1rem;">
                            Открыть шлагбаум
                        </button>
                        <div id="barrierResult" class="text-center" style="min-height: 2em;"></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="camerasTab" role="tabpanel">
            <h5 class="fw-bold mb-4">Снимок с камер</h5>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h6>Камера 1 (192.0.0.12)</h6>
                        <div id="snapshot-192-0-0-12" class="mb-2 camera-snapshot-container" style="width:100%;max-width:500px;height:220px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;overflow:hidden;">
                            <span class="text-muted">Нет снимка</span>
                        </div>
                        <button class="btn btn-gradient w-100" onclick="takeSnapshot('192.0.0.12', 'snapshot-192-0-0-12');return false;">Сделать снимок</button>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h6>Камера 2 (192.0.0.11)</h6>
                        <div id="snapshot-192-0-0-11" class="mb-2 camera-snapshot-container" style="width:100%;max-width:500px;height:220px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;overflow:hidden;">
                            <span class="text-muted">Нет снимка</span>
                        </div>
                        <button class="btn btn-gradient w-100" onclick="takeSnapshot('192.0.0.11', 'snapshot-192-0-0-11');return false;">Сделать снимок</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tariffsTab" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Тарифы</h5>
                <button class="btn btn-gradient" id="addTariffBtn">Добавить тариф</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="tariffsTable">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Дневной</th>
                            <th>Ночной</th>
                            <th>Бесплатно (мин)</th>
                            <th>Макс. часов</th>
                            <th>Активный</th>
                            <!-- <th>Действует с</th>
                            <th>Действует до</th> -->
                            <th>Описание</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="10" class="text-center">Загрузка...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="whitelistTab" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Белый список номеров</h5>
                <button class="btn btn-gradient" id="addWhitelistBtn">Добавить номер</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="whitelistTable">
                    <thead>
                        <tr>
                            <th>Номер</th>
                            <th>Срок с</th>
                            <th>Срок до</th>
                            <th>Комментарий</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="text-center">Загрузка...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="activeTab" role="tabpanel">
            <div class="mb-4">
                <h5 class="fw-bold mb-2">Активные машины на парковке</h5>
                <div class="mb-3">
                    <span class="fw-semibold">Всего активных:</span>
                    <span id="activeCount" class="badge bg-primary">0</span>
                </div>
                
                <!-- Улучшенная фильтрация для активных -->
                <div class="filter-box">
                    <div class="filter-title">Фильтры и поиск</div>
                    <form id="activeFilterForm" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="activePlateSearch" class="form-label">Поиск по номеру</label>
                            <input type="text" id="activePlateSearch" class="form-control" placeholder="A123BC или часть номера">
                        </div>
                        <div class="col-md-3">
                            <label for="activeSortOrder" class="form-label">Сортировка</label>
                            <select id="activeSortOrder" class="form-select">
                                <option value="desc">Новые въезды сверху</option>
                                <option value="asc">Старые въезды сверху</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-secondary w-100" id="clearActiveFilters">Сброс</button>
                        </div>
                    </form>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="activeVisitsTable">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Время въезда</th>
                                <th>Камера</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" class="text-center">Загрузка...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="visitsTab" role="tabpanel">
            <div>
                <h5 class="fw-bold mb-2">Все визиты — фильтрация и поиск</h5>
                
                <!-- Улучшенная фильтрация для визитов -->
                <div class="filter-box">
                    <div class="filter-title">Фильтры и поиск</div>
                    <form id="visitsFilterForm" class="mb-3">
                        <div class="row g-3 align-items-end mb-3">
                            <!-- <div class="col-md-2">
                                <label for="visitsDate" class="form-label">Дата</label>
                                <input type="text" id="visitsDate" class="form-control">
                            </div> -->
                            <div class="col-md-2">
                                <label for="statusFilter" class="form-label">Статус</label>
                                <select id="statusFilter" class="form-select">
                                    <option value="">Все статусы</option>
                                    <option value="active">Активные</option>
                                    <option value="completed">Завершённые</option>
                                    <option value="timeout">Таймаут</option>
                                    <option value="manual">Вручную</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="plateSearch" class="form-label">Поиск по номеру</label>
                                <input type="text" id="plateSearch" class="form-control" placeholder="A123BC или часть">
                            </div>
                            <div class="col-md-2">
                                <label for="sortOrder" class="form-label">Сортировка</label>
                                <select id="sortOrder" class="form-select">
                                    <option value="desc">Новые сверху</option>
                                    <option value="asc">Старые сверху</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-secondary w-100" id="clearVisitsFilters">Сброс фильтров</button>
                            </div>
                        </div>
                        
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label for="visitsDate" class="form-label">Дата</label>
                                <input type="date" id="visitsDate" class="form-control">
                            </div>
                            <div class="col-md-2">
                                <label for="entryFrom" class="form-label">Въезд с (часы:минуты)</label>
                                <input type="time" id="entryFrom" class="form-control" placeholder="часы:минуты">
                            </div>
                            <div class="col-md-2">
                                <label for="entryTo" class="form-label">Въезд до (часы:минуты)</label>
                                <input type="time" id="entryTo" class="form-control" placeholder="часы:минуты">
                            </div>
                            <div class="col-md-2">
                                <span class="fw-semibold d-block">Всего найдено:</span>
                                <span id="visitsCount" class="badge bg-success fs-6">0</span>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="visitsByDateTable">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Въезд</th>
                                <th>Выезд</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="text-center">Загрузка...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="paymentsTab" role="tabpanel">
            <div class="mb-4">
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-3">
                        <label for="paymentsDate" class="form-label">Дата</label>
                        <input type="date" id="paymentsDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <span class="fw-semibold d-block">Всего оплат:</span>
                        <span id="paymentsCount" class="badge bg-success fs-6">0</span>
                    </div>
                </div>
                <!-- Фильтрация и поиск -->
                <div class="filter-box mb-4">
                    <div class="filter-title">Фильтры и поиск</div>
                    <form id="paymentsFilterForm" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="paymentsPlateSearch" class="form-label">Поиск по номеру</label>
                            <input type="text" id="paymentsPlateSearch" class="form-control" placeholder="A123BC или часть номера">
                        </div>
                        <div class="col-md-2">
                            <label for="paymentsStatusFilter" class="form-label">Статус</label>
                            <select id="paymentsStatusFilter" class="form-select">
                                <option value="">Все</option>
                                <option value="paid">Оплачено</option>
                                <option value="pending">В ожидании</option>
                                <option value="failed">Ошибка</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="paymentsMinAmount" class="form-label">Мин. сумма</label>
                            <input type="number" id="paymentsMinAmount" class="form-control" min="0" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <label for="paymentsMaxAmount" class="form-label">Макс. сумма</label>
                            <input type="number" id="paymentsMaxAmount" class="form-control" min="0" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <label for="paymentsSortOrder" class="form-label">Сортировка</label>
                            <select id="paymentsSortOrder" class="form-select">
                                <option value="desc">Новые сверху</option>
                                <option value="asc">Старые сверху</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-secondary w-100" id="clearPaymentsFilters">Сброс</button>
                        </div>
                    </form>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm" style="background: linear-gradient(90deg, #4facfe 0%, #53a9ee 100%); color: #fff; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                            <div class="card-body py-3" style="flex:1;text-align:center;">
                                <div style="font-size: 1.1rem; font-weight: 500; opacity:0.85;">Сумма оплат за день</div>
                                <div id="paymentsSum" style="font-size: 2.7rem; font-weight: 700; margin-top: 0.5rem; letter-spacing:1px;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <canvas id="paymentsChart" height="70"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Сумма</th>
                                <th>Время оплаты</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="text-center">Загрузка...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="analyticsTab" role="tabpanel">
            <div class="mb-4">
                <h5 class="fw-bold mb-2">Общая аналитика</h5>
<div id="parkingAnalyticsBlock">
    <div>Среднее количество въездов в день: <span id="avgEntriesPerDay">-</span></div>
    <div>Среднее время стоянки: <span id="avgDuration">-</span></div>
    <div class="mt-3">
        <h6>Распределение въездов по часам</h6>
        <div>
            <canvas id="hourlyChart" height="80"></canvas>
        </div>
    </div>
    <div class="mt-3">
        <h6>Среднее время стоянки по дням недели (минуты)</h6>
        <div>
            <canvas id="weekdayAvgDurationChart" height="80"></canvas>
        </div>
    </div>
    <div class="mt-3">
        <h6>Въезды и выезды по дням недели</h6>
        <div>
            <canvas id="weekdayEntryExitChart" height="80"></canvas>
        </div>
    </div>
</div>
            </div>
            <div>
                <h5 class="fw-bold mb-2">Аналитика по номерам (за неделю)</h5>
                <div class="mb-3" style="max-width:300px;">
                    <input type="text" id="platesAnalyticsSearch" class="form-control" placeholder="Поиск по номеру">
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="platesAnalyticsTable">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Заездов</th>
                                <th>Среднее время стоянки</th>
                                <th>Средний час въезда</th>
                                <th>Средний час выезда</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center">Загрузка...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="errorsTab" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Логи сервера (последние)</h5>
                <div class="d-flex align-items-center gap-2">
                    <select id="logLevelSelect" class="form-select form-select-sm" style="width:auto;">
                        <option value="err">Ошибки</option>
                        <option value="info">Все логи</option>
                    </select>
                    <button class="btn btn-gradient" id="refreshErrorsBtn">Обновить</button>
                </div>
            </div>
            <pre id="serverErrorsLog" style="background:#222;color:#fff;padding:16px;border-radius:8px;max-height:400px;overflow:auto;font-size:13px;">Загрузка...</pre>
        </div>
    </div>
</div>

<div class="modal fade" id="whitelistModal" tabindex="-1" aria-labelledby="whitelistModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="whitelistForm">
      <div class="modal-header">
        <h5 class="modal-title" id="whitelistModalLabel">Добавить номер в белый список</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="whitelistId">
        <div class="mb-3">
          <label for="plateNumber" class="form-label">Номер</label>
          <input type="text" class="form-control" id="plateNumber" required>
        </div>
        <div class="mb-3">
          <label for="validFrom" class="form-label">Срок с</label>
          <input type="date" class="form-control" id="validFrom" required>
        </div>
        <div class="mb-3">
          <label for="validUntil" class="form-label">Срок до</label>
          <input type="date" class="form-control" id="validUntil">
        </div>
        <div class="mb-3">
          <label for="whitelistComment" class="form-label">Комментарий</label>
          <input type="text" class="form-control" id="whitelistComment">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-gradient">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="tariffModal" tabindex="-1" aria-labelledby="tariffModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="tariffForm">
      <div class="modal-header">
        <h5 class="modal-title" id="tariffModalLabel">Добавить тариф</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="tariffName" class="form-label">Название</label>
          <input type="text" class="form-control" id="tariffName" required>
        </div>
        <div class="mb-3">
          <label for="tariffHourly" class="form-label">Дневной тариф</label>
          <input type="number" class="form-control" id="tariffHourly" required>
        </div>
        <div class="mb-3">
          <label for="tariffNight" class="form-label">Ночной тариф</label>
          <input type="number" class="form-control" id="tariffNight" required>
        </div>
        <div class="mb-3">
          <label for="tariffFree" class="form-label">Бесплатно (мин)</label>
          <input type="number" class="form-control" id="tariffFree" required>
        </div>
        <div class="mb-3">
          <label for="tariffMax" class="form-label">Макс. часов</label>
          <input type="number" class="form-control" id="tariffMax" required>
        </div>
        <div class="mb-3">
          <label for="tariffDesc" class="form-label">Описание</label>
          <input type="text" class="form-control" id="tariffDesc">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-gradient">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
let paymentsChart;
let paymentsInterval = null;
let paymentsDataRaw = [];
let paymentsFiltered = [];
function filterPaymentsData() {
    const plate = document.getElementById('paymentsPlateSearch').value.trim().toUpperCase();
    const status = document.getElementById('paymentsStatusFilter').value;
    const minAmount = parseFloat(document.getElementById('paymentsMinAmount').value);
    const maxAmount = parseFloat(document.getElementById('paymentsMaxAmount').value);
    paymentsFiltered = paymentsDataRaw.filter(row => {
        let ok = true;
        if (plate && !(row.plate_number || '').toUpperCase().includes(plate)) ok = false;
        if (status && row.payment_status !== status) ok = false;
        if (!isNaN(minAmount) && row.amount < minAmount) ok = false;
        if (!isNaN(maxAmount) && row.amount > maxAmount) ok = false;
        return ok;
    });
}
function renderPaymentsTableAndChart() {
    document.getElementById('paymentsCount').textContent = paymentsFiltered.length;
    let sum = paymentsFiltered.reduce((acc, row) => acc + row.amount, 0);
    document.getElementById('paymentsSum').textContent = sum.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' сом';
    const tbody = document.querySelector('#paymentsTable tbody');
    tbody.innerHTML = '';
    if (paymentsFiltered.length) {
        const sortOrder = document.getElementById('paymentsSortOrder').value;
        let sorted = [...paymentsFiltered];
        sorted.sort((a, b) => {
            const tA = a.paid_at ? new Date(a.paid_at).getTime() : 0;
            const tB = b.paid_at ? new Date(b.paid_at).getTime() : 0;
            return sortOrder === 'asc' ? tA - tB : tB - tA;
        });
        sorted.forEach(row => {
            tbody.innerHTML += `<tr>
                <td>${renderPlate(row.plate_number)}</td>
                <td>${row.amount.toFixed(2)}</td>
                <td>${row.paid_at ? formatTimeOnly(row.paid_at) : ''}</td>
                <td>${row.payment_status}</td>
            </tr>`;
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Нет оплат</td></tr>';
    }
    const chartElem = document.getElementById('paymentsChart');
    if (paymentsFiltered.length) {
        const hours = Array.from({length: 24}, (_, i) => i);
        const paymentsByHour = Array(24).fill(0);
        paymentsFiltered.forEach(row => {
            if (row.paid_at) {
                const d = new Date(row.paid_at);
                const h = d.getHours();
                paymentsByHour[h] += row.amount;
            }
        });
        if (paymentsChart) {
            paymentsChart.data.labels = hours.map(h => `${h}:00`);
            paymentsChart.data.datasets[0].data = paymentsByHour;
            paymentsChart.update();
        } else {
            paymentsChart = new Chart(chartElem.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'Сумма по часам',
                            data: paymentsByHour,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Час' } },
                        y: { title: { display: true, text: 'Сумма (сом)' }, beginAtZero: true, ticks: { precision:0 } }
                    }
                }
            });
        }
    } else {
        if (paymentsChart) {
            paymentsChart.data.labels = [];
            paymentsChart.data.datasets[0].data = [];
            paymentsChart.update();
        }
    }
}
function loadPaymentsAnalytics() {
    const dateInput = document.getElementById('paymentsDate');
    let day = dateInput.value;
    if (!day) {
        const today = new Date();
        day = today.toISOString().slice(0,10);
        dateInput.value = day;
    }
    fetch(`/admin/analytics/payments?day=${encodeURIComponent(day)}`)
        .then(r => r.json())
        .then(data => {
            paymentsDataRaw = data.payments || [];
            filterPaymentsData();
            renderPaymentsTableAndChart();
        });
}
document.getElementById('payments-tab').addEventListener('click', function() {
    loadPaymentsAnalytics();
    if (!paymentsInterval) {
        paymentsInterval = setInterval(loadPaymentsAnalytics, 5000);
    }
});
document.getElementById('paymentsDate').addEventListener('change', function() {
    loadPaymentsAnalytics();
});
document.getElementById('paymentsPlateSearch').addEventListener('input', function() {
    filterPaymentsData();
    renderPaymentsTableAndChart();
});
document.getElementById('paymentsStatusFilter').addEventListener('change', function() {
    filterPaymentsData();
    renderPaymentsTableAndChart();
});
document.getElementById('paymentsMinAmount').addEventListener('input', function() {
    filterPaymentsData();
    renderPaymentsTableAndChart();
});
document.getElementById('paymentsMaxAmount').addEventListener('input', function() {
    filterPaymentsData();
    renderPaymentsTableAndChart();
});
document.getElementById('paymentsSortOrder').addEventListener('change', function() {
    renderPaymentsTableAndChart();
});
document.getElementById('clearPaymentsFilters').addEventListener('click', function() {
    document.getElementById('paymentsPlateSearch').value = '';
    document.getElementById('paymentsStatusFilter').value = '';
    document.getElementById('paymentsMinAmount').value = '';
    document.getElementById('paymentsMaxAmount').value = '';
    document.getElementById('paymentsSortOrder').value = 'desc';
    filterPaymentsData();
    renderPaymentsTableAndChart();
});
document.getElementById('adminTabs').addEventListener('shown.bs.tab', function (event) {
    const targetTab = event.target.getAttribute('data-bs-target');
    if (targetTab !== '#paymentsTab' && paymentsInterval) {
        clearInterval(paymentsInterval);
        paymentsInterval = null;
    }
});
</script>
<script>
function takeSnapshot(cameraIp, targetId) {
    const snapshotDiv = document.getElementById(targetId);
    snapshotDiv.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;">
        <div class="spinner-border text-primary" role="status" style="width:2.5rem;height:2.5rem;">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <span class="text-muted mt-2">Загрузка...</span>
      </div>
    `;
    fetch(`/admin/camera-snapshot/${cameraIp}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.image) {
                snapshotDiv.innerHTML = `
                  <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
                    <img src="${data.image}" alt="Снимок с камеры" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;display:block;margin:auto;">
                  </div>
                `;
            } else {
                snapshotDiv.innerHTML = `<span class="text-danger">Ошибка: ${data.error || 'Нет связи'}</span>`;
            }
        })
        .catch(() => {
            snapshotDiv.innerHTML = '<span class="text-danger">Ошибка подключения</span>';
        });
}
</script>
<script>
let heartbeatInterval = null;
function startHeartbeat() {
    if (heartbeatInterval) return;
    heartbeatInterval = setInterval(() => {
        fetch('/admin/heartbeat', {method: 'POST'}).catch(()=>{});
    }, 20000);
    fetch('/admin/heartbeat', {method: 'POST'}).catch(()=>{});
}
function stopHeartbeat() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        startHeartbeat();
    } else {
        stopHeartbeat();
    }
});
window.addEventListener('focus', startHeartbeat);
window.addEventListener('blur', stopHeartbeat);
window.addEventListener('beforeunload', stopHeartbeat);
if (document.visibilityState === 'visible') startHeartbeat();
</script>
<script>
let hourlyChart;
let weekdayAvgDurationChart;
let weekdayEntryExitChart;
function loadParkingAnalytics() {
    fetch('/admin/analytics/parking')
        .then(r => r.json())
        .then(data => {
            document.getElementById('avgEntriesPerDay').textContent = data.avg_entries_per_day ?? '-';
            document.getElementById('avgDuration').textContent = formatMinutesToHM(data.avg_duration_minutes);

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const entryValues = labels.map((_, i) => (data.hourly_distribution && typeof data.hourly_distribution[i] !== 'undefined') ? data.hourly_distribution[i] : 0);
            const exitValues = labels.map((_, i) => (data.hourly_exit_distribution && typeof data.hourly_exit_distribution[i] !== 'undefined') ? data.hourly_exit_distribution[i] : 0);

            if (hourlyChart) {
                hourlyChart.data.labels = labels;
                hourlyChart.data.datasets[0].data = entryValues;
                hourlyChart.data.datasets[1].data = exitValues;
                hourlyChart.update();
            } else {
                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Въездов',
                                data: entryValues,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)'
                            },
                            {
                                label: 'Выездов',
                                data: exitValues,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Час' } },
                            y: { title: { display: true, text: 'Количество' }, beginAtZero: true, ticks: { precision:0 } }
                        }
                    }
                });
            }

            const weekdayCtx = document.getElementById('weekdayAvgDurationChart').getContext('2d');
            const weekdayLabels = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            const weekdayData = weekdayLabels.map((_, i) => (data.weekday_avg_duration && typeof data.weekday_avg_duration[i] !== 'undefined') ? data.weekday_avg_duration[i] : 0);

            if (weekdayAvgDurationChart) {
                weekdayAvgDurationChart.data.labels = weekdayLabels;
                weekdayAvgDurationChart.data.datasets[0].data = weekdayData;
                weekdayAvgDurationChart.update();
            } else {
                weekdayAvgDurationChart = new Chart(weekdayCtx, {
                    type: 'bar',
                    data: {
                        labels: weekdayLabels,
                        datasets: [
                            {
                                label: 'Среднее время стоянки (мин)',
                                data: weekdayData,
                                backgroundColor: 'rgba(39, 174, 96, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'День недели' } },
                            y: { title: { display: true, text: 'Минуты' }, beginAtZero: true, ticks: { precision:0 } }
                        }
                    }
                });
            }

            const weekdayEntryExitCtx = document.getElementById('weekdayEntryExitChart').getContext('2d');
            const weekdayEntryData = weekdayLabels.map((_, i) => (data.weekday_entry_distribution && typeof data.weekday_entry_distribution[i] !== 'undefined') ? data.weekday_entry_distribution[i] : 0);
            const weekdayExitData = weekdayLabels.map((_, i) => (data.weekday_exit_distribution && typeof data.weekday_exit_distribution[i] !== 'undefined') ? data.weekday_exit_distribution[i] : 0);

            if (weekdayEntryExitChart) {
                weekdayEntryExitChart.data.labels = weekdayLabels;
                weekdayEntryExitChart.data.datasets[0].data = weekdayEntryData;
                weekdayEntryExitChart.data.datasets[1].data = weekdayExitData;
                weekdayEntryExitChart.update();
            } else {
                weekdayEntryExitChart = new Chart(weekdayEntryExitCtx, {
                    type: 'bar',
                    data: {
                        labels: weekdayLabels,
                        datasets: [
                            {
                                label: 'Въездов',
                                data: weekdayEntryData,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)'
                            },
                            {
                                label: 'Выездов',
                                data: weekdayExitData,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'День недели' } },
                            y: { title: { display: true, text: 'Количество' }, beginAtZero: true, ticks: { precision:0 } }
                        }
                    }
                });
            }
        });
}
    function formatHourDecimalToTime(val) {
        if (val === null || val === undefined || isNaN(val)) return '-';
        const hour = Math.floor(val);
        const min = Math.round((val - hour) * 60);
        return `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
    }
    function formatMinutesToHM(mins) {
        if (mins === null || mins === undefined || isNaN(mins)) return '-';
        mins = Math.round(mins);
        if (mins < 60) return `${mins} мин`;
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        if (m === 0) return `${h} ч`;
        return `${h} ч ${m} мин`;
    }
    let platesAnalyticsData = [];
    function loadPlatesAnalytics() {
        fetch('/admin/analytics/plates')
            .then(r => r.json())
            .then(data => {
                platesAnalyticsData = data || [];
                renderPlatesAnalyticsTable();
            });
    }
    function renderPlatesAnalyticsTable() {
        const tbody = document.querySelector('#platesAnalyticsTable tbody');
        const search = document.getElementById('platesAnalyticsSearch').value.trim().toUpperCase();
        let filtered = platesAnalyticsData;
        if (search) {
            filtered = platesAnalyticsData.filter(row => (row.plate_number || '').toUpperCase().includes(search));
        }
        tbody.innerHTML = '';
        if (filtered.length) {
            filtered.forEach(row => {
                tbody.innerHTML += `<tr>
                    <td>${renderPlate(row.plate_number)}</td>
                    <td>${row.count}</td>
                    <td>${formatMinutesToHM(row.avg_duration_minutes)}</td>
                    <td>${formatHourDecimalToTime(row.avg_entry_hour)}</td>
                    <td>${formatHourDecimalToTime(row.avg_exit_hour)}</td>
                </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Нет данных</td></tr>';
        }
    }
    document.getElementById('platesAnalyticsSearch').addEventListener('input', renderPlatesAnalyticsTable);
    document.getElementById('analytics-tab').addEventListener('click', function() {
        loadParkingAnalytics();
        loadPlatesAnalytics();
    });
    function renderRate(val) {
        if (!val) return '';
        if (typeof val === 'string' && /^(\d{2}:\d{2}(:\d{2})?)$/.test(val)) return '';
        return Number(val).toFixed(2);
    }
    function formatTimeOnly(dt) {
        if (!dt) return '';
        const d = new Date(dt);
        return d.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    }
    function formatDateTime(dt) {
        if (!dt) return '';
        const d = new Date(dt);
        return d.toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    }
    function renderStatusBadge(status) {
        let text = '';
        let cls = '';
        switch (status) {
            case 'active':
                text = 'Активный';
                cls = 'badge-active';
                break;
            case 'completed':
                text = 'Завершён';
                cls = 'badge-completed';
                break;
            case 'timeout':
                text = 'Таймаут';
                cls = 'badge-timeout';
                break;
            case 'manual':
                text = 'Вручную';
                cls = 'badge-manual';
                break;
            default:
                text = status;
                cls = 'bg-secondary';
        }
        return `<span class="badge ${cls}">${text}</span>`;
    }
    function renderPlate(number) {
        if (!number || number.length < 5) return number;
        const region = number.slice(0,2);
        let digits = "";
        let letters = "";
        if (/^\d{2}\d{3}[A-ZА-Я]{3}$/i.test(number)) {
            digits = number.slice(2,5);
            letters = number.slice(5,8);
        } else {
            digits = number.slice(2);
            letters = "";
        }
        return `<span class="plate-simple"><span class="plate-region">${region}</span><span class="plate-sep"></span><span class="plate-main">${digits}${letters}</span></span>`;
    }

    function updateCurrentMode() {
        fetch('/admin/parking-mode')
            .then(r => r.json())
            .then(data => {
                document.getElementById('currentMode').textContent = data.mode === 'free' ? 'Без оплаты' : 'С оплатой';
                document.getElementById('modeSwitch').checked = data.mode === 'free';
                document.getElementById('modeSwitchLabel').textContent = data.mode === 'free' ? 'Без оплаты' : 'С оплатой';
            });
    }
    document.getElementById('modeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const mode = document.getElementById('modeSwitch').checked ? 'free' : 'paid';
        fetch('/admin/parking-mode', {
            method: 'POST',
            body: new URLSearchParams({mode}),
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        }).then(() => updateCurrentMode());
    });
    updateCurrentMode();

    document.getElementById('barrierForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const resultSpan = document.getElementById('barrierResult');
        resultSpan.textContent = 'Открытие...';
        fetch('/admin/barrier-open-default', {
            method: 'POST'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                resultSpan.textContent = 'Шлагбаум открыт!';
                resultSpan.className = 'ms-3 text-success';
            } else {
                resultSpan.textContent = 'Ошибка открытия!';
                resultSpan.className = 'ms-3 text-danger';
            }
        })
        .catch(() => {
            resultSpan.textContent = 'Ошибка соединения!';
            resultSpan.className = 'ms-3 text-danger';
        });
    });

    let tariffModal = new bootstrap.Modal(document.getElementById('tariffModal'));
    function loadTariffs() {
        fetch('/tariffs/list')
            .then(r => r.json())
            .then(data => {
                const tbody = document.querySelector('#tariffsTable tbody');
                tbody.innerHTML = '';
                if (data.tariffs && data.tariffs.length) {
                    data.tariffs.forEach(tariff => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${tariff.name}</td>
                                <td>${renderRate(tariff.hourly_rate)}</td>
                                <td>${renderRate(tariff.night_rate)}</td>
                                <td>${tariff.free_minutes}</td>
                                <td>${tariff.max_hours}</td>
                                <td>${tariff.is_active ? '<span class="badge bg-success">Да</span>' : ''}</td>
                                <!-- <td>${tariff.valid_from ? formatDateTime(tariff.valid_from) : ''}</td>
                                <td>${tariff.valid_until ? formatDateTime(tariff.valid_until) : ''}</td> -->
                                <td>${tariff.description || ''}</td>
                                <td>
                                    ${!tariff.is_active ? `
                                    <div class="dropdown">
                                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        Действия
                                      </button>
                                      <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="activateTariff(${tariff.id});return false;">Активировать</a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteTariff(${tariff.id});return false;">Удалить</a></li>
                                      </ul>
                                    </div>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center">Нет тарифов</td></tr>';
                }
            });
    }
    function activateTariff(id) {
        fetch(`/tariffs/activate/${id}`, {method: 'POST'})
            .then(() => loadTariffs());
    }
    function deleteTariff(id) {
        if (confirm('Удалить тариф?')) {
            fetch(`/tariffs/${id}`, {method: 'DELETE'})
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(data => { throw new Error(data.detail || "Ошибка удаления"); });
                    }
                    loadTariffs();
                })
                .catch(e => alert("Ошибка: " + e.message));
        }
    }
    document.getElementById('tariffs-tab').addEventListener('click', function() {
        loadTariffs();
        if (!window._tariffsInterval) {
            window._tariffsInterval = setInterval(loadTariffs, 5000);
        }
    });
    document.getElementById('addTariffBtn').addEventListener('click', function() {
        document.getElementById('tariffForm').reset();
        tariffModal.show();
    });
    document.getElementById('tariffForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const payload = {
            name: document.getElementById('tariffName').value.trim(),
            hourly_rate: parseFloat(document.getElementById('tariffHourly').value),
            night_rate: parseFloat(document.getElementById('tariffNight').value),
            free_minutes: parseInt(document.getElementById('tariffFree').value),
            max_hours: parseInt(document.getElementById('tariffMax').value),
            description: document.getElementById('tariffDesc').value.trim()
        };
        fetch('/tariffs/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            tariffModal.hide();
            loadTariffs();
        });
    });

    let whitelistModal = new bootstrap.Modal(document.getElementById('whitelistModal'));
    function loadWhitelist() {
        fetch('/admin/whitelist')
            .then(r => r.json())
            .then(data => {
                const tbody = document.querySelector('#whitelistTable tbody');
                tbody.innerHTML = '';
                if (data && data.length) {
                    data.forEach(entry => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${renderPlate(entry.plate_number)}</td>
                                <td>${entry.valid_from ? entry.valid_from.slice(0,10) : ''}</td>
                                <td>${entry.valid_until ? entry.valid_until.slice(0,10) : ''}</td>
                                <td>${entry.comment || ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editWhitelist(${entry.id})">✏️</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteWhitelist(${entry.id})">🗑️</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Нет номеров</td></tr>';
                }
            });
    }
    document.getElementById('whitelist-tab').addEventListener('click', function() {
        loadWhitelist();
        if (!window._whitelistInterval) {
            window._whitelistInterval = setInterval(loadWhitelist, 5000);
        }
    });
    document.getElementById('addWhitelistBtn').addEventListener('click', function() {
        document.getElementById('whitelistForm').reset();
        document.getElementById('whitelistId').value = '';
        document.getElementById('whitelistModalLabel').textContent = 'Добавить номер в белый список';
        whitelistModal.show();
    });
    function editWhitelist(id) {
        fetch('/admin/whitelist')
            .then(r => r.json())
            .then(data => {
                const entry = data.find(e => e.id === id);
                if (entry) {
                    document.getElementById('whitelistId').value = entry.id;
                    document.getElementById('plateNumber').value = entry.plate_number;
                    document.getElementById('validFrom').value = entry.valid_from ? entry.valid_from.slice(0,10) : '';
                    document.getElementById('validUntil').value = entry.valid_until ? entry.valid_until.slice(0,10) : '';
                    document.getElementById('whitelistComment').value = entry.comment || '';
                    document.getElementById('whitelistModalLabel').textContent = 'Редактировать номер';
                    whitelistModal.show();
                }
            });
    }
    document.getElementById('whitelistForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('whitelistId').value;
        const plate_number = document.getElementById('plateNumber').value.trim();
        const valid_from = document.getElementById('validFrom').value;
        const valid_until = document.getElementById('validUntil').value;
        const comment = document.getElementById('whitelistComment').value.trim();
        const payload = {
            plate_number,
            valid_from: valid_from ? new Date(valid_from).toISOString().slice(0,10) : new Date().toISOString().slice(0,10),
            valid_until: valid_until ? new Date(valid_until).toISOString().slice(0,10) : null,
            comment
        };
        if (id) {
            fetch(`/admin/whitelist/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(() => {
                whitelistModal.hide();
                loadWhitelist();
            });
        } else {
            fetch('/admin/whitelist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(() => {
                whitelistModal.hide();
                loadWhitelist();
            });
        }
    });
    function deleteWhitelist(id) {
        if (confirm('Удалить номер из белого списка?')) {
            fetch(`/admin/whitelist/${id}`, {method: 'DELETE'})
                .then(() => loadWhitelist());
        }
    }

    function loadActiveVisits() {
        const plate = document.getElementById('activePlateSearch').value.trim();
        const sort = document.getElementById('activeSortOrder').value;
        
        let url = '/admin/active-visits';
        let params = [];
        if (plate) params.push(`plate=${encodeURIComponent(plate)}`);
        if (sort) params.push(`sort=${encodeURIComponent(sort)}`);
        if (params.length) url += '?' + params.join('&');

        fetch(url)
            .then(r => r.json())
            .then(data => {
                const tbody = document.querySelector('#activeVisitsTable tbody');
                tbody.innerHTML = '';
                document.getElementById('activeCount').textContent = data.length;
                if (data.length) {
                    data.forEach(entry => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${renderPlate(entry.plate_number)}</td>
                                <td>${entry.entry_time ? formatTimeOnly(entry.entry_time) : ''}</td>
                                <td>${entry.entry_camera_ip || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center">Нет активных машин</td></tr>';
                }
            });
    }

    document.getElementById('active-tab').addEventListener('click', function() {
        loadActiveVisits();
        if (!window._activeInterval) {
            window._activeInterval = setInterval(loadActiveVisits, 5000);
        }
    });

    document.getElementById('activePlateSearch').addEventListener('input', function() {
        loadActiveVisits();
    });

    document.getElementById('activeSortOrder').addEventListener('change', function() {
        loadActiveVisits();
    });

    document.getElementById('clearActiveFilters').addEventListener('click', function() {
        document.getElementById('activePlateSearch').value = '';
        document.getElementById('activeSortOrder').value = 'desc';
        loadActiveVisits();
    });

    function loadVisitsByDate() {
        const day = document.getElementById('visitsDate').value;
        const status = document.getElementById('statusFilter').value;
        let entryFrom = document.getElementById('entryFrom').value;
        let entryTo = document.getElementById('entryTo').value;
        const plate = document.getElementById('plateSearch').value.trim();
        const sort = document.getElementById('sortOrder').value;

        function combineDateTime(date, time) {
            if (!date || !time) return "";
            return date + " " + time;
        }
        let params = [];
        if (day) params.push(`day=${encodeURIComponent(day)}`);
        if (status) params.push(`status=${encodeURIComponent(status)}`);
        if (entryFrom) params.push(`entry_from=${encodeURIComponent(combineDateTime(day, entryFrom))}`);
        if (entryTo) params.push(`entry_to=${encodeURIComponent(combineDateTime(day, entryTo))}`);
        if (plate) params.push(`plate=${encodeURIComponent(plate)}`);
        if (sort) params.push(`sort=${encodeURIComponent(sort)}`);

        const url = '/admin/visits-by-date' + (params.length ? '?' + params.join('&') : '');

        fetch(url)
            .then(r => r.json())
            .then(data => {
                const tbody = document.querySelector('#visitsByDateTable tbody');
                tbody.innerHTML = '';
                document.getElementById('visitsCount').textContent = data.length;
                if (data.length) {
                    data.forEach(entry => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${renderPlate(entry.plate_number)}</td>
                                <td>${entry.entry_time ? formatTimeOnly(entry.entry_time) : ''}</td>
                                <td>${entry.exit_time ? formatTimeOnly(entry.exit_time) : ''}</td>
                                <td>${renderStatusBadge(entry.visit_status)}</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Нет визитов</td></tr>';
                }
            });
    }

    document.getElementById('visits-tab').addEventListener('click', function() {
        const dateInput = document.getElementById('visitsDate');
        if (!dateInput.value) {
            const today = new Date();
            dateInput.value = today.toISOString().slice(0,10);
        }
        loadVisitsByDate();
        if (!window._visitsInterval) {
            window._visitsInterval = setInterval(loadVisitsByDate, 5000);
        }
    });

    document.getElementById('adminTabs').addEventListener('shown.bs.tab', function (event) {
        const targetTab = event.target.getAttribute('data-bs-target');
        if (targetTab !== '#visitsTab' && window._visitsInterval) {
            clearInterval(window._visitsInterval);
            window._visitsInterval = null;
        }
    });

    document.getElementById('statusFilter').addEventListener('change', loadVisitsByDate);
    document.getElementById('plateSearch').addEventListener('input', loadVisitsByDate);
    document.getElementById('sortOrder').addEventListener('change', loadVisitsByDate);

    document.getElementById('clearVisitsFilters').addEventListener('click', function() {
        document.getElementById('visitsDate').value = new Date().toISOString().slice(0,10);
        document.getElementById('statusFilter').value = '';
        document.getElementById('entryFrom').value = '';
        document.getElementById('entryTo').value = '';
        document.getElementById('plateSearch').value = '';
        document.getElementById('sortOrder').value = 'desc';
        loadVisitsByDate();
    });

    function loadServerErrors() {
        const logElem = document.getElementById('serverErrorsLog');
        const level = document.getElementById('logLevelSelect').value;
        logElem.textContent = 'Загрузка...';
        fetch(`/admin/server-errors?lines=50&level=${encodeURIComponent(level)}`)
            .then(r => r.json())
            .then(data => {
                if (data.logs && data.logs.length) {
                    logElem.textContent = data.logs.join('\n');
                } else if (data.error) {
                    logElem.textContent = 'Ошибка: ' + data.error;
                } else {
                    logElem.textContent = 'Нет логов за последние события.';
                }
            })
            .catch(e => {
                logElem.textContent = 'Ошибка загрузки: ' + e;
            });
    }
    document.getElementById('errors-tab').addEventListener('click', function() {
        loadServerErrors();
    });
    document.getElementById('refreshErrorsBtn').addEventListener('click', function() {
        loadServerErrors();
    });
    document.getElementById('logLevelSelect').addEventListener('change', function() {
        loadServerErrors();
    });
</script>
</body>
</html>
